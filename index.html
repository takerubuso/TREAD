<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聖徳太子なりきりAR（安全起動版）</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            /* 起動確認のため、あえて黒にします。正常なら中央に白いキャンバスが出ます */
            background-color: #000; 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        canvas {
            position: absolute;
            transform: scaleX(-1); 
        }
        video { display: none; }
        #status {
            position: absolute;
            top: 10px; right: 10px;
            color: #333;
            font-family: sans-serif; font-size: 14px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 5px; z-index: 100; pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="status">システム起動中...</div>
    <video id="input_video" autoplay playsinline></video>
    <canvas id="output_canvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://pixijs.download/v7.x/pixi.min.js"></script>

    <script>
        // =========== 設定エリア ===========
        const IMAGE_PATH = 'face.png'; 
        const FACE_SCALE = 1.0; 
        const MOUTH_SENSITIVITY = 2.5; 
        // =================================

        const videoElement = document.getElementById('input_video');
        const statusElement = document.getElementById('status');
        let faceMesh, selfieSegmentation, camera;
        let pixiApp, faceSprite, segmentationMaskSprite;
        let videoTexture, bgSolidSprite, fgVideoSprite;
        
        let frameCounter = 0;
        let isSegmentationReady = false;

        function log(msg) { statusElement.textContent = msg; console.log(msg); }

        function initPixi() {
            pixiApp = new PIXI.Application({
                view: document.getElementById('output_canvas'),
                width: window.innerWidth, height: window.innerHeight,
                transparent: false, 
                backgroundColor: 0xFFFFFF, // キャンバスの中身は白
                resizeTo: window, autoDensity: true
            });
            videoTexture = PIXI.Texture.from(videoElement);

            // レイヤー1：白背景
            bgSolidSprite = new PIXI.Sprite(PIXI.Texture.WHITE);
            bgSolidSprite.tint = 0xFFFFFF;
            pixiApp.stage.addChild(bgSolidSprite);

            // レイヤー2：顔イラスト
            faceSprite = new PIXI.Sprite(PIXI.Texture.from(IMAGE_PATH));
            faceSprite.anchor.set(0.5);
            faceSprite.visible = false; 
            pixiApp.stage.addChild(faceSprite);

            // レイヤー3：人物映像
            fgVideoSprite = new PIXI.Sprite(videoTexture);
            pixiApp.stage.addChild(fgVideoSprite);
            
            // マスク用スプライト（作成するが、まだ適用しない！）
            segmentationMaskSprite = new PIXI.Sprite(PIXI.Texture.WHITE);

            // ★重要：最初はマスクを「null（なし）」にして、映像をそのまま出す
            fgVideoSprite.mask = null; 

            window.addEventListener('resize', resizeAll);
            resizeAll();
        }

        function resizeAll() {
            const w = pixiApp.screen.width; const h = pixiApp.screen.height;
            if(bgSolidSprite) { bgSolidSprite.width = w; bgSolidSprite.height = h; }
            if(fgVideoSprite) { fgVideoSprite.width = w; fgVideoSprite.height = h; }
            if(segmentationMaskSprite) { segmentationMaskSprite.width = w; segmentationMaskSprite.height = h; }
        }

        function onFaceMeshResults(results) {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                if (frameCounter % 60 === 0) log("稼働中");
                faceSprite.visible = true;
                const landmarks = results.multiFaceLandmarks[0];
                const nose = landmarks[1];
                faceSprite.position.set(nose.x * pixiApp.screen.width, nose.y * pixiApp.screen.height);

                const leftCheek = landmarks[234]; const rightCheek = landmarks[454];
                const faceWidthPx = Math.hypot(
                    (rightCheek.x - leftCheek.x) * pixiApp.screen.width,
                    (rightCheek.y - leftCheek.y) * pixiApp.screen.height
                );
                const baseScale = (faceWidthPx / 512) * FACE_SCALE;

                const upperLip = landmarks[13]; const lowerLip = landmarks[14];
                const mouthDist = Math.hypot(
                    (upperLip.x - lowerLip.x) * pixiApp.screen.width,
                    (upperLip.y - lowerLip.y) * pixiApp.screen.height
                );
                let mouthRatio = Math.max(0, (mouthDist / faceWidthPx) - 0.02);
                const scaleY = baseScale * (1 + mouthRatio * MOUTH_SENSITIVITY);
                faceSprite.scale.set(baseScale, scaleY);

                const leftEye = landmarks[33]; const rightEye = landmarks[263];
                faceSprite.rotation = Math.atan2(rightEye.y - leftEye.y, rightEye.x - leftEye.x);
            } else {
                faceSprite.visible = false;
            }
        }

        function onSelfieSegmentationResults(results) {
            // AIが結果を返してきたら、マスク画像を更新
            segmentationMaskSprite.texture = PIXI.Texture.from(results.segmentationMask);
            segmentationMaskSprite.width = pixiApp.screen.width;
            segmentationMaskSprite.height = pixiApp.screen.height;

            // ★ここで初めてマスクを適用する（映像がパッと切り替わります）
            if (!isSegmentationReady) {
                isSegmentationReady = true;
                fgVideoSprite.mask = segmentationMaskSprite;
                log("切り抜き開始！");
            }
        }

        async function start() {
            log("初期化中..."); 
            try {
                initPixi();
                
                faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                faceMesh.onResults(onFaceMeshResults);

                selfieSegmentation = new SelfieSegmentation({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
                selfieSegmentation.setOptions({ modelSelection: 1 }); 
                selfieSegmentation.onResults(onSelfieSegmentationResults);

                log("カメラを要求します...");
                camera = new Camera(videoElement, {
                    onFrame: async () => {
                        frameCounter++;
                        const tasks = [];
                        tasks.push(faceMesh.send({image: videoElement}));
                        // 最初は毎回切り抜きを行い、安定したら間引く
                        if (!isSegmentationReady || frameCounter % 3 === 0) {
                            tasks.push(selfieSegmentation.send({image: videoElement})); 
                        }
                        await Promise.all(tasks);
                        videoTexture.update();
                    },
                    width: 640, height: 480
                });
                await camera.start();
                log("カメラ起動成功。AIモデル読み込み中...");
            } catch (e) {
                log("エラー発生: " + e);
                alert("起動エラー: " + e);
            }
        }
        start();
    </script>
</body>
</html>
